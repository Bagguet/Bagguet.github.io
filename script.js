const attackers = [
  "gallery/attackers/150px-R6S_Ace_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Amaru_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Ash_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Blackbeard_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Blitz_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Brava_Icon_2023_allmode.png",
  "gallery/attackers/150px-R6S_Buck_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Capitao_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Deimos_Operator_Icon.png",
  "gallery/attackers/150px-R6S_Dokkaebi_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Finka_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Flores_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Fuze_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Glaz_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Gridlock_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Grim_Icon_2022_allmode.png",
  "gallery/attackers/150px-R6S_Hibana_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_IQ_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Iana_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Jackal_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Kali_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Lion_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Maverick_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Montagne_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Nomad_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Nokk_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Osa_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Ram_Icon_2022_allmode.png",
  "gallery/attackers/150px-R6S_Sledge_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Striker_Operator_Icon.png",
  "gallery/attackers/150px-R6S_Thatcher_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Thermite_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Twitch_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Ying_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Zero_Icon_2021_allmode.png",
  "gallery/attackers/150px-R6S_Zofia_Icon_2021_allmode.png",
  "gallery/attackers/R6S_Rauora_Icon_2025_allmode.png",
  "gallery/attackers/R6S_Sens_Icon_2022_allmode.png",
];

const defenders = [
  "gallery/defenders/150px-R6S_Alibi_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Aruni_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Azami_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Bandit_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Castle_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Caveira_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Clash_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Doc_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Echo_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Ela_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Frost_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Goyo_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Jager_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Kaid_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Kapkan_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Lesion_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Maestro_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Melusi_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Mira_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Mozzie_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Mute_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Oryx_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Pulse_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Rook_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Sentry_Operator_Icon.png",
  "gallery/defenders/150px-R6S_Skopos_Icon_2024_allmode.png",
  "gallery/defenders/150px-R6S_Smoke_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Solis_Icon_2022_allmode.png",
  "gallery/defenders/150px-R6S_Tachanka_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Thorn_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Thunderbird_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Tubarao_Operator_Icon.png",
  "gallery/defenders/150px-R6S_Valkyrie_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Vigil_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Wamai_Icon_2021_allmode.png",
  "gallery/defenders/150px-R6S_Warden_Icon_2021_allmode.png",
  "gallery/defenders/161px-R6S_Fenrir_Operator_Icon.png",
];

function extractName(path) {
  const match = path.match(/R6S_(.*?)_/);
  return match ? match[1] : "Unknown";
}

function changeAttacker(imgId, nameId) {
  const img = document.getElementById(imgId);
  const nameEl = document.getElementById(nameId);

  const randomIndex = Math.floor(Math.random() * attackers.length);
  const newSrc = attackers[randomIndex];

  img.src = newSrc;
  nameEl.textContent = extractName(newSrc);
}

function changeDefender(imgId, nameId) {
  const img = document.getElementById(imgId);
  const nameEl = document.getElementById(nameId);

  const randomIndex = Math.floor(Math.random() * defenders.length);
  const newSrc = defenders[randomIndex];

  img.src = newSrc;
  nameEl.textContent = extractName(newSrc);
}

let availableAttackers = [...attackers];
let availableDefenders = [...defenders];
let currentSquad = [];

// Function to load squad from JSON file
function loadSquad(squadFile) {
  return fetch(squadFile)
    .then((res) => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then((data) => {
      currentSquad = data.squad;
      renderSquad();
    })
    .catch((error) => {
      console.error("Error loading squad:", error);
      alert(`Error loading squad: ${error.message}`);
    });
}

// Function to render the squad
function renderSquad() {
  const container = document.getElementById("squadContainer");
  container.innerHTML = "";

  // Reset operator pools
  availableAttackers = [...attackers];
  availableDefenders = [...defenders];

  currentSquad.forEach((member, index) => {
    const card = document.createElement("div");
    card.className = "card";

    const attackerId = `randomAttacker-${index}`;
    const attackerNameId = `attackerName-${index}`;
    const defenderId = `randomDefender-${index}`;
    const defenderNameId = `defenderName-${index}`;

    card.innerHTML = `
      <div class="toggle-container">
        <label class="switch">
          <input type="checkbox" id="switch-${index}" checked>
          <span class="slider round"></span>
        </label>
        <span>Include in randomizer</span>
      </div>
      <h1>${member}</h1>
      <div class="operator-section attacker">
        <div class="badge attacker-badge">Attacker</div>
        <img id="${attackerId}" class="operator-img" />
        <h4 id="${attackerNameId}"></h4>
        <button id="attackerBtn-${index}" class="refresh-btn">New Attacker</button>
      </div>
      <div class="operator-section defender">
        <div class="badge defender-badge">Defender</div>
        <img id="${defenderId}" class="operator-img" />
        <h4 id="${defenderNameId}"></h4>
        <button id="defenderBtn-${index}" class="refresh-btn">New Defender</button>
      </div>
    `;

    container.appendChild(card);

    // Get references to the UI elements
    const switchInput = document.getElementById(`switch-${index}`);
    const attackerSection = card.querySelector(".attacker");
    const defenderSection = card.querySelector(".defender");

    // Initialize operators for this card
    assignUniqueOperator(attackerId, attackerNameId, availableAttackers);
    assignUniqueOperator(defenderId, defenderNameId, availableDefenders);

    // Add event listeners
    document
      .getElementById(`attackerBtn-${index}`)
      .addEventListener("click", () => {
        if (switchInput.checked) {
          putBackOperator(attackerId, availableAttackers);
          assignUniqueOperator(attackerId, attackerNameId, availableAttackers);
        }
      });

    document
      .getElementById(`defenderBtn-${index}`)
      .addEventListener("click", () => {
        if (switchInput.checked) {
          putBackOperator(defenderId, availableDefenders);
          assignUniqueOperator(defenderId, defenderNameId, availableDefenders);
        }
      });

    // Toggle switch event listener
    switchInput.addEventListener("change", function () {
      if (this.checked) {
        attackerSection.style.display = "block";
        defenderSection.style.display = "block";
        // Reassign operators when toggling back on
        assignUniqueOperator(attackerId, attackerNameId, availableAttackers);
        assignUniqueOperator(defenderId, defenderNameId, availableDefenders);
      } else {
        // Return operators to their pools when toggling off
        const attackerImg = document.getElementById(attackerId);
        const defenderImg = document.getElementById(defenderId);

        if (attackerImg && attackerImg.src) {
          availableAttackers.push(attackerImg.src);
        }
        if (defenderImg && defenderImg.src) {
          availableDefenders.push(defenderImg.src);
        }

        attackerSection.style.display = "none";
        defenderSection.style.display = "none";
      }
    });
  });
}

// Initialize the application
window.addEventListener("DOMContentLoaded", () => {
  // Add event listener for squad selection
  const squadSelector = document.getElementById("squadSelector");
  if (squadSelector) {
    // Set default selected squad to Squad 2 (squad1.json)
    squadSelector.value = "squad.json";

    squadSelector.addEventListener("change", function () {
      loadSquad(this.value);
    });
  }

  // Load initial squad (Squad 2 by default)
  loadSquad("squad.json");

  // Add event listener for the refresh all button
  document
    .getElementById("changeAllBtn")
    ?.addEventListener("click", function () {
      // Reset operator pools
      availableAttackers = [...attackers];
      availableDefenders = [...defenders];

      // Change all operators for the current squad
      currentSquad.forEach((_, index) => {
        const attackerId = `randomAttacker-${index}`;
        const attackerNameId = `attackerName-${index}`;
        const defenderId = `randomDefender-${index}`;
        const defenderNameId = `defenderName-${index}`;

        // Check if the toggle is enabled for this member
        const toggle = document.getElementById(`switch-${index}`);
        if (!toggle || toggle.checked) {
          // Put current operators back in the pool
          const attackerImg = document.getElementById(attackerId);
          const defenderImg = document.getElementById(defenderId);

          if (attackerImg && attackerImg.src) {
            availableAttackers.push(attackerImg.src);
          }
          if (defenderImg && defenderImg.src) {
            availableDefenders.push(defenderImg.src);
          }

          // Assign new operators
          assignUniqueOperator(attackerId, attackerNameId, availableAttackers);
          assignUniqueOperator(defenderId, defenderNameId, availableDefenders);
        }
      });
    });
});

// Helper to assign unique operator
function assignUniqueOperator(imgId, nameId, pool) {
  if (pool.length === 0) return;

  const img = document.getElementById(imgId);
  const nameEl = document.getElementById(nameId);

  const randomIndex = Math.floor(Math.random() * pool.length);
  const newSrc = pool[randomIndex];

  img.src = newSrc;
  nameEl.textContent = extractName(newSrc);

  pool.splice(randomIndex, 1); // remove from pool
}

// Helper to put current operator back into the pool
function putBackOperator(imgId, pool) {
  const img = document.getElementById(imgId);
  if (!img.src) return;

  const filename = img.src.split("/").pop(); // just filename
  if (!pool.includes(filename)) {
    pool.push(img.src); // add back
  }
}

// Extract operator name from filename
function extractName(src) {
  const match = src.match(/R6S_(.+?)_/);
  return match ? match[1] : "";
}
